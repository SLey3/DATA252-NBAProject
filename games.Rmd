---
title: "ML_project"
author:
  - Jerrick Little
  - Sergio Ley Languren
  - Aadem Isai
  - D'Ante Dean
date: "2026-02-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GGally)
library(caret)

setwd("/Users/aademisai/Desktop/DATA252-NBAProject") # or wherever your project path is located at

DATA_DIR = "./data"
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
games = read.csv(paste(DATA_DIR, "/Games.csv", sep = ""))
teams = read.csv(paste(DATA_DIR, "/TeamStatistics.csv", sep = ""))
games = games %>%
  filter(gameDateTimeEst >= "2019-07-29 22:00:00") %>%
  filter(gameType == "Regular Season") %>%
  mutate(
    #Positive means home team won
    point_diff = homeScore - awayScore,
    total_points = homeScore + awayScore,
    winner = factor(winner),
    gameType = factor(gameType),
    gameSubtype = factor(gameSubtype)
  )
games <- games %>%
  mutate(winner_name = case_when(
    winner == hometeamId ~ hometeamName,
    winner == awayteamId ~ awayteamName,
    TRUE ~ NA_character_
  ))
# Getting all the regular szn games in teams data

names(games)

nba_divs <- data.frame(
  teamId = c(
    1610612738, 1610612751, 1610612752, 1610612755, 1610612761,

    1610612741, 1610612739, 1610612765, 1610612754, 1610612749,

    1610612737, 1610612766, 1610612748, 1610612753, 1610612764,

    1610612743, 1610612750, 1610612760, 1610612757, 1610612762,

    1610612744, 1610612746, 1610612747, 1610612756, 1610612758,

    1610612742, 1610612745, 1610612763, 1610612740, 1610612759
  ),
  teamName = c(
  "Celtics", "Nets", "Knicks", "76ers", "Raptors",

    "Bulls", "Cavaliers", "Pistons", "Pacers", "Bucks",

    "Hawks", "Hornets", "Heat", "Magic", "Wizards",
   "Nuggets", "Timberwolves", "Thunder", "Trail Blazers", "Jazz",

    "Warriors", "Clippers", "Lakers", "Suns", "Kings",

    "Mavericks", "Rockets", "Grizzlies", "Pelicans", "Spurs"
  ),
  conference = c(
    rep("Eastern", 5),

    rep("Eastern", 5),

    rep("Eastern", 5),

    rep("Western", 5),

    rep("Western", 5),

    rep("Western", 5)
  ),
  division = c(
    rep("Atlantic", 5),

    rep("Central", 5),

    rep("Southeast", 5),

    rep("Northwest", 5),

    rep("Pacific", 5),

    rep("Southwest", 5)
  ),
  stringsAsFactors = FALSE
)

teams <- teams %>%
  left_join(nba_divs %>% select(teamId, conference, division), 
            by = "teamId")
teams <- teams %>%
  left_join(games %>% select(gameId, attendance, winner_name, arenaCity),
            by = "gameId")

teams = teams %>%
  filter(gameDateTimeEst >= "2019-07-29 22:00:00")%>%
  semi_join(games %>% filter(gameType == "Regular Season"), by = "gameId")%>%
  mutate(point_diff = teamScore - opponentScore)%>%
  mutate(arenaCity = case_when(
    home == 1 ~ teamCity,              # If home, use team's city
    home == 0 ~ opponentTeamCity,      # If away, use opponent's city
    TRUE ~ arenaCity                   # Keep existing value if neither (shouldn't happen)
  ))

names(teams)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot_data <- teams %>%
  select(
    teamScore,        # Numeric response variable
    attendance,       # Numeric predictor
    win,     # Numeric predictor           # Categorical
    arenaCity,
    assists# Categorical
  ) %>%
  # Remove rows with missing values
  drop_na()

plot_data2 <- teams %>%
  select(
    teamScore,        # Numeric response variable
    reboundsTotal,       # Numeric predictor
    win,     # Numeric predictor           # Categorical
    arenaCity,
    fieldGoalsPercentage# Categorical
  ) %>%
  # Remove rows with missing values
  drop_na()
plot_data3 <- teams %>%
  select(
    teamScore,        # Numeric response variable
    turnovers,       # Numeric predictor
    win,     # Numeric predictor           # Categorical
    conference,
    foulsPersonal# Categorical
  ) %>%
  # Remove rows with missing values
  drop_na()
plot_data4 <- teams %>%
  select(
    teamScore,        # Numeric response variable
    freeThrowsMade,       # Numeric predictor
    win,     # Numeric predictor           # Categorical
    steals,
    pointsInThePaint# Categorical
  ) %>%
  # Remove rows with missing values
  drop_na()
plot_data5 <- teams %>%
  select(
    teamScore,                 # Response variable
    fieldGoalsPercentage,      # Shooting accuracy
    threePointersPercentage,   # 3-point shooting
    freeThrowsPercentage,      # Free throw accuracy
    win                        # Outcome
  ) %>%
  drop_na()
plot_data6 <- teams %>%
  select(
    teamScore,                 # Response variable
    assists,                   # Ball movement
    turnovers,                 # Ball security
    steals,                    # Defensive pressure
    blocks                     # Rim protection
  ) %>%
  drop_na()
plot_data7 <- teams %>%
  select(
    teamScore,                 # Response variable
    reboundsOffensive,         # Offensive boards
    reboundsDefensive,         # Defensive boards
    reboundsTotal,             # Total rebounds
    pointsSecondChance         # Points off rebounds
  ) %>%
  drop_na()
plot_data8 <- teams %>%
  select(
    teamScore,                 # Response variable
    home,                      # Home/Away indicator
    attendance,                # Crowd size
    win,                       # Outcome
    conference                 # Conference
  ) %>%
  drop_na()
plot_data9 <- teams %>%
  select(
    teamScore,                 # Response variable
    fieldGoalsAttempted,       # Total shots
    threePointersAttempted,    # 3-point attempts
    freeThrowsAttempted,       # Free throw attempts
    fieldGoalsMade             # Made field goals
  ) %>%
  drop_na()

plot_data10 <- teams %>%
  select(
    teamScore,
    arenaCity,
    fieldGoalsPercentage,
    fieldGoalsMade,
    win
  ) %>%
  drop_na()
ggpairs(plot_data, cardinality_threshold = 34,
        title = "NBA Games Analysis: Pairs Plot",
        aes( alpha = 0.5)) +
  theme(axis.text.x = element_text(angle = 90))+
  theme_bw()

ggpairs(plot_data2, cardinality_threshold = 35,
        title = "NBA Games Analysis: Pairs Plot",
        aes( alpha = 0.5)) +
  theme(axis.text.x = element_text(angle = 90))+
  theme_bw()
ggpairs(plot_data3, cardinality_threshold = 34,
        title = "NBA Games Analysis: Pairs Plot",
        aes( alpha = 0.5)) +
  theme(axis.text.x = element_text(angle = 90))+
  theme_bw()
ggpairs(plot_data4, cardinality_threshold = 34,
        title = "NBA Games Analysis: Pairs Plot",
        aes( alpha = 0.5)) +
  theme(axis.text.x = element_text(angle = 90))+
  theme_bw()
ggpairs(plot_data5, cardinality_threshold = 34,
         title = "NBA Games Analysis: Pairs Plot",
         aes( alpha = 0.5)) +
   theme(axis.text.x = element_text(angle = 90))+
   theme_bw()
ggpairs(plot_data6, cardinality_threshold = 34,
         title = "NBA Games Analysis: Pairs Plot",
         aes( alpha = 0.5)) +
   theme(axis.text.x = element_text(angle = 90))+
   theme_bw()
ggpairs(plot_data7, cardinality_threshold = 34,
         title = "NBA Games Analysis: Pairs Plot",
         aes( alpha = 0.5)) +
   theme(axis.text.x = element_text(angle = 90))+
   theme_bw()
ggpairs(plot_data8, cardinality_threshold = 34,
         title = "NBA Games Analysis: Pairs Plot",
         aes( alpha = 0.5)) +
   theme(axis.text.x = element_text(angle = 90))+
   theme_bw()
ggpairs(plot_data9, cardinality_threshold = 34,
         title = "NBA Games Analysis: Pairs Plot",
         aes( alpha = 0.5)) +
   theme(axis.text.x = element_text(angle = 90))+
   theme_bw()
ggpairs(plot_data10, cardinality_threshold = 35,
         title = "NBA Games Analysis: Pairs Plot",
         aes( alpha = 0.5)) +
   theme(axis.text.x = element_text(angle = 90))+
   theme_bw()
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# Part 2 Q3
- For every one rebound, the point diff will go up .8. By the end of the game, a team will have around 45 rebounds. So the point diff will be around 0.
```{r}
teams_winners <- teams %>%
 filter(win == 1)
names(teams_winners)

lm_mod = lm(point_diff ~ fieldGoalsPercentage, data = teams_winners, na.action = na.exclude)
summary(lm_mod)
ggplot(teams_winners, aes(x = fieldGoalsPercentage, y = point_diff)) +
  geom_point(alpha = 0.05) +
  geom_line(aes(y = predict(lm_mod)), color = "blue4", linewidth = 1) +
  scale_y_continuous(transform = "log10", breaks = seq(0, 60, by = 10)) 

```
# Part 2 Q4
- The slope is .82 for both since they're parallel. The Eastern conference is the reference conference so that intercept is -36.12 and the western conference intercept is -36.12 + .283. They're not far off from each other and basically overlay.
```{r}
teams$conference = factor(teams$conference)
parallel_mod = lm(point_diff ~ fieldGoalsPercentage + conference, data = teams_winners,na.action = na.exclude)
summary(parallel_mod)

ggplot(teams_winners, aes(x = fieldGoalsPercentage, y = point_diff, color = conference)) +
  geom_point(alpha = 0.2) +
  geom_line(aes(y = predict(parallel_mod)), alpha = 8, linewidth = 2)
```

# Part 2 Q 6
- For the eastern conference, it's -36.13 + .816 * reboundsTotal. The Western conference is (-36.13 + .302) + (.816 - .00043) * reboundsTotal. Again VERY similar lines.
```{r}
interaction_mod <- lm(point_diff ~ fieldGoalsPercentage * conference, data = teams_winners, na.action = na.exclude)
summary(interaction_mod)

ggplot(teams_winners, aes(x = fieldGoalsPercentage, y = point_diff, color = conference)) +
  geom_point(alpha = 0.2) +
  geom_line(aes(y = predict(interaction_mod)), alpha = 1, linewidth = 2)

```
# Part 2 Q 7
- The parallel lines RMSE test has the smallest RMSE with a value of 14.1708. However, all three and honestly, all 6 are SUPER similar. This corresponds with what we saw in our graphs. This is because conference and rebounds don't contribute much to the point differential. All cross validated models are bigger but that makes sense because it wasn't trained on the data like the whole RMSE has been. The whole RMSE tests have already seen every data point.
```{r}
teams_clean <- teams_winners[, c("point_diff", "fieldGoalsPercentage", "benchPoints")]
teams_clean <- na.omit(teams_clean)
ctrl <- trainControl(method = "cv", number = 10)

simple_cv <- train(point_diff ~ fieldGoalsPercentage, 
                   data = teams_clean, method = "lm", trControl = ctrl)

parallel_cv <- train(point_diff ~ fieldGoalsPercentage + benchPoints, 
                     data = teams_clean, method = "lm", trControl = ctrl)

interaction_cv <- train(point_diff ~ fieldGoalsPercentage * benchPoints, 
                        data = teams_clean, method = "lm", trControl = ctrl)

simple_mod      <- lm(point_diff ~ fieldGoalsPercentage, data = teams_clean)
parallel_mod    <- lm(point_diff ~ fieldGoalsPercentage + benchPoints, data = teams_clean)
interaction_mod <- lm(point_diff ~ fieldGoalsPercentage * benchPoints, data = teams_clean)

rmse <- function(model) sqrt(mean(residuals(model)^2))

results <- data.frame(
  Model      = c("Simple", "Parallel Lines", "Interaction"),
  RMSE_whole = c(rmse(simple_mod), rmse(parallel_mod), rmse(interaction_mod)),
  RMSE_cv    = c(simple_cv$results$RMSE, parallel_cv$results$RMSE, interaction_cv$results$RMSE)
)
print(results)
```

# Extra tests vvv
```{r}
library(ggplot2)
lm(seasonWins ~ point_diff, data = teams, se = FALSE)
lm(formula = teamScore ~ fieldGoalsPercentage + threePointersPercentage + 
    freeThrowsPercentage, data = teams)
lm(teamScore ~ home, data = teams) # Playing at home gives about 2 point increase in team score
lm(win ~ home + attendance, data = teams) # playing at home teams have on average 54.65% chance of winning, away 45.34... attendance basically zero so not much impact on winning.
lm(point_diff ~ assists + turnovers + reboundsTotal, data = teams)
lm(win ~ assists + turnovers + reboundsTotal + fieldGoalsPercentage, data = teams) #- Comprehensive winning model
lm(opponentScore ~ steals + blocks + reboundsDefensive, data = teams)
lm(win ~ steals + blocks + reboundsDefensive, data = teams)
lm(win ~ opponentScore + teamScore, data = teams)


#very limited data change to Arenacity after logic implemented
ggplot(teams_winners, aes(x = arenaCity, y = point_diff)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

cor_matrix <- teams %>%
  select(point_diff, teamScore, opponentScore, assists, reboundsTotal, 
         steals, blocks, turnovers, fieldGoalsPercentage, 
         threePointersPercentage, freeThrowsPercentage, 
         pointsInThePaint, pointsFastBreak, benchPoints, 
         attendance, home, win) %>%
  cor(use = "complete.obs")

# View correlations with point_diff
cor_matrix[, "point_diff"]

cor_winners <- teams_winners %>%
  select(point_diff, teamScore, opponentScore, assists, reboundsTotal, 
         steals, blocks, turnovers, fieldGoalsPercentage, 
         threePointersPercentage, freeThrowsPercentage, 
         pointsInThePaint, pointsFastBreak, benchPoints, 
         attendance, home) %>%
  cor(use = "complete.obs")

# View correlations with point_diff
cor_winners[, "point_diff"]


comparison <- data.frame(
  Variable = c("benchPoints", "fieldGoalsPercentage", "teamScore", "opponentScore", 
               "assists", "pointsFastBreak", "steals", "threePointersPercentage",
               "pointsInThePaint", "reboundsTotal", "turnovers", "blocks", 
               "freeThrowsPercentage", "home", "attendance"),
  All_Teams = c(0.139, 0.556, 0.622, -0.622, 0.413, 0.251, 0.252, 0.378,
                0.305, 0.331, -0.238, 0.158, 0.085, 0.098, 0),
  Winners_Only = c(0.417, 0.408, 0.400, -0.468, 0.320, 0.239, 0.266, 0.259,
                   0.190, 0.128, -0.068, 0.053, 0.053, 0.040, 0.008)
) %>%
  mutate(Change = Winners_Only - All_Teams) %>%
  arrange(desc(abs(Change)))

print(comparison)

```